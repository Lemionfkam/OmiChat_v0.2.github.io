<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMI Chat v0.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
                /* ===== VARIABLES ===== */
        :root {
            --primary: #4285F4;
            --primary-dark: #3367D6;
            --primary-light: #8AB4F8;
            --secondary: #34A853;
            --secondary-dark: #2E8B57;
            --secondary-light: #81C995;
            --error: #EA4335;
            --error-dark: #D33426;
            --error-light: #F28B82;
            --warning: #FBBC05;
            --warning-dark: #F29900;
            --warning-light: #FDE293;
            
            --gray-50: #f8f9fa;
            --gray-100: #f1f3f4;
            --gray-200: #e8eaed;
            --gray-300: #dadce0;
            --gray-400: #bdc1c6;
            --gray-500: #9aa0a6;
            --gray-600: #80868b;
            --gray-700: #5f6368;
            --gray-800: #3c4043;
            --gray-900: #202124;
            
            --dark-bg: #0f1419;
            --dark-card: #1a1f25;
            --dark-border: #2d333b;
            --dark-text: #e6edf3;
            --dark-text-secondary: #8b949e;
            
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.2);
            --shadow-xl: 0 12px 32px rgba(0,0,0,0.25);
            --shadow-inset: inset 0 1px 0 rgba(255,255,255,0.1);
            
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 14px;
            --border-radius-xl: 18px;
            --border-radius-full: 9999px;
            
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            --spacing-2xl: 24px;
            --spacing-3xl: 32px;
            --spacing-4xl: 40px;
        }
        
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            font-size: 16px;
            height: 100%;
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1c2128 100%);
            min-height: 100vh;
            color: var(--dark-text);
            line-height: 1.5;
            padding: var(--spacing-lg);
            display: flex;
            justify-content: center;
            align-items: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* ===== TYPOGRAPHY ===== */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.2;
            margin-bottom: var(--spacing-md);
            color: var(--dark-text);
        }
        
        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }
        h3 { font-size: 1.5rem; }
        h4 { font-size: 1.125rem; }
        
        p {
            margin-bottom: var(--spacing-lg);
            color: var(--dark-text-secondary);
        }
        
        small {
            font-size: 0.875rem;
            opacity: 0.7;
        }
        
        strong {
            font-weight: 600;
            color: var(--dark-text);
        }
        
        /* ===== LOGIN MODAL ===== */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn var(--transition-slow);
            padding: var(--spacing-lg);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .login-card {
            background: var(--dark-card);
            padding: var(--spacing-4xl);
            border-radius: var(--border-radius-xl);
            width: 100%;
            max-width: 440px;
            text-align: center;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--dark-border);
            animation: slideUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .login-logo {
            margin-bottom: var(--spacing-2xl);
            display: flex;
            justify-content: center;
            animation: logoFloat 3s ease-in-out infinite;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .login-input {
            width: 100%;
            padding: var(--spacing-xl);
            margin: var(--spacing-2xl) 0;
            border: 2px solid var(--dark-border);
            border-radius: var(--border-radius-full);
            font-size: 1rem;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.05);
            color: var(--dark-text);
            outline: none;
            transition: all var(--transition-fast);
            text-align: center;
        }
        
        .login-input:focus {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }
        
        .login-input::placeholder {
            color: var(--dark-text-secondary);
        }
        
        .login-button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: var(--spacing-xl) var(--spacing-3xl);
            border-radius: var(--border-radius-full);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            width: 100%;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }
        
        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .login-button:active {
            transform: translateY(0);
        }
        
        .login-footer {
            margin-top: var(--spacing-2xl);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--dark-border);
            color: var(--dark-text-secondary);
        }
        
        /* ===== CHAT APP LAYOUT ===== */
        .chat-app {
            display: none;
            width: 100%;
            max-width: 1400px;
            height: 92vh;
            background: var(--dark-card);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            border: 1px solid var(--dark-border);
            animation: scaleIn 0.4s ease;
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, var(--dark-card) 0%, rgba(26, 31, 37, 0.95) 100%);
            border-right: 1px solid var(--dark-border);
            display: flex;
            flex-direction: column;
            padding: var(--spacing-xl);
            gap: var(--spacing-xl);
            position: relative;
            overflow: hidden;
        }
        
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
        }
        
        .user-card {
            text-align: center;
            padding: var(--spacing-2xl);
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--dark-border);
            transition: transform var(--transition-normal);
            position: relative;
            overflow: hidden;
        }
        
        .user-card:hover {
            transform: translateY(-2px);
            border-color: rgba(66, 133, 244, 0.3);
        }
        
        .user-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        
        .avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 50%;
            margin: 0 auto var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            box-shadow: var(--shadow-lg);
            border: 3px solid rgba(255, 255, 255, 0.1);
            transition: transform var(--transition-normal);
        }
        
        .user-card:hover .avatar {
            transform: scale(1.05) rotate(5deg);
        }
        
        .connection-status {
            font-size: 0.875rem;
            color: var(--dark-text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--secondary);
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 0 rgba(52, 168, 83, 0.7);
        }
        
        @keyframes pulse {
            0% { 
                box-shadow: 0 0 0 0 rgba(52, 168, 83, 0.7);
            }
            70% { 
                box-shadow: 0 0 0 6px rgba(52, 168, 83, 0);
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(52, 168, 83, 0);
            }
        }
        
        .status-connected .status-indicator {
            background: var(--secondary);
        }
        
        .status-disconnected .status-indicator {
            background: var(--error);
            animation: none;
        }
        
        .user-stats {
            display: flex;
            justify-content: center;
            gap: var(--spacing-xl);
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--dark-border);
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.875rem;
            color: var(--dark-text-secondary);
        }
        
        .stat-icon {
            font-size: 1rem;
        }
        
        .online-users {
            flex: 1;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            border: 1px solid var(--dark-border);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .online-users h4 {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            color: var(--dark-text);
            font-size: 1rem;
        }
        
        .icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .badge {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2px 8px;
            border-radius: var(--border-radius-full);
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: auto;
        }
        
        #usersList {
            flex: 1;
            overflow-y: auto;
            padding-right: var(--spacing-sm);
        }
        
        .user-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-md);
            margin: var(--spacing-xs) 0;
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-fast);
            cursor: pointer;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid transparent;
        }
        
        .user-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(66, 133, 244, 0.2);
        }
        
        .user-item::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--secondary);
            border-radius: 50%;
            margin-right: var(--spacing-md);
            flex-shrink: 0;
        }
        
        .user-item.self::before {
            background: var(--primary);
        }
        
        /* ===== MODERN BUTTONS STYLES ===== */
        .sidebar-footer {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            margin-top: auto;
            padding: var(--spacing-lg);
            background: linear-gradient(135deg, rgba(15, 20, 25, 0.8) 0%, rgba(26, 31, 37, 0.9) 100%);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--dark-border);
            box-shadow: var(--shadow-inset), 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: var(--spacing-md);
            border: 1px solid var(--dark-border);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            background: rgba(255, 255, 255, 0.05);
            color: var(--dark-text-secondary);
            position: relative;
            overflow: hidden;
            min-height: 80px;
            aspect-ratio: 1;
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(10px);
        }
        
        .btn:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.4),
                0 0 0 1px var(--btn-border-color, var(--primary)),
                var(--shadow-inset);
            background: rgba(255, 255, 255, 0.08);
            color: white;
        }
        
        .btn:active {
            transform: translateY(-1px) scale(0.98);
            transition: all 0.1s;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--btn-border-color, var(--primary)) 50%, 
                transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .btn:hover::before {
            opacity: 1;
        }
        
        .btn-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }
        
        .btn:hover .btn-icon {
            transform: scale(1.15);
        }
        
        .btn-icon svg {
            width: 100%;
            height: 100%;
            transition: all 0.3s;
        }
        
        .btn:hover .btn-icon svg {
            filter: brightness(1.2);
        }
        
        .btn-text {
            font-size: 11px;
            font-weight: 500;
            text-align: center;
            line-height: 1.2;
            transition: all 0.3s;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        
        .btn:hover .btn-text {
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        
        /* Цвета кнопок */
        .btn-primary {
            --btn-border-color: var(--primary);
        }
        
        .btn-primary .btn-icon svg {
            fill: var(--primary-light);
        }
        
        .btn-primary:hover {
            --btn-border-color: var(--primary-light);
            background: linear-gradient(135deg, 
                rgba(66, 133, 244, 0.15) 0%, 
                rgba(138, 180, 248, 0.1) 100%);
        }
        
        .btn-success {
            --btn-border-color: var(--secondary);
        }
        
        .btn-success .btn-icon svg {
            fill: var(--secondary-light);
        }
        
        .btn-success:hover {
            --btn-border-color: var(--secondary-light);
            background: linear-gradient(135deg, 
                rgba(52, 168, 83, 0.15) 0%, 
                rgba(129, 201, 149, 0.1) 100%);
        }
        
        .btn-secondary {
            --btn-border-color: var(--gray-600);
        }
        
        .btn-secondary .btn-icon svg {
            fill: var(--gray-500);
        }
        
        .btn-secondary:hover {
            --btn-border-color: var(--gray-500);
            background: linear-gradient(135deg, 
                rgba(95, 99, 104, 0.15) 0%, 
                rgba(154, 160, 166, 0.1) 100%);
        }
        
        .btn-danger {
            --btn-border-color: var(--error);
        }
        
        .btn-danger .btn-icon svg {
            fill: var(--error-light);
        }
        
        .btn-danger:hover {
            --btn-border-color: var(--error-light);
            background: linear-gradient(135deg, 
                rgba(234, 67, 53, 0.15) 0%, 
                rgba(242, 139, 130, 0.1) 100%);
        }
        
        /* Бейдж для уведомлений */
        .btn-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background: linear-gradient(135deg, var(--error), var(--error-dark));
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            animation: badgePulse 2s infinite;
            display: none;
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Кнопка Logout - особый стиль */
        .btn-logout {
            grid-column: span 3;
            aspect-ratio: auto;
            min-height: 52px;
            flex-direction: row;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            margin-top: var(--spacing-sm);
            border-width: 2px;
        }
        
        .btn-logout .btn-icon {
            width: 20px;
            height: 20px;
        }
        
        .btn-logout .btn-text {
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        /* Анимация загрузки */
        .btn-loading .btn-icon {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Состояние отключения */
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn:disabled:hover {
            box-shadow: var(--shadow-sm);
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* ===== CHAT MAIN AREA ===== */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(15, 20, 25, 0.8);
        }
        
        .chat-header {
            padding: var(--spacing-lg) var(--spacing-2xl);
            border-bottom: 1px solid var(--dark-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(26, 31, 37, 0.95);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .chat-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }
        
        .chat-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-info {
            font-size: 0.875rem;
            color: var(--dark-text-secondary);
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }
        
        .divider {
            opacity: 0.5;
        }
        
        .chat-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }
        
        .typing-indicator {
            font-size: 0.875rem;
            color: var(--dark-text-secondary);
            display: none;
            align-items: center;
            gap: var(--spacing-sm);
            animation: fadeIn 0.3s ease;
        }
        
        .dots {
            display: flex;
            gap: 3px;
        }
        
        .dots span {
            width: 4px;
            height: 4px;
            background: var(--secondary);
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }
        
        .dots span:nth-child(2) { animation-delay: 0.2s; }
        .dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        
        /* ===== MESSAGES CONTAINER ===== */
        .messages-container {
            flex: 1;
            padding: var(--spacing-2xl);
            overflow-y: auto;
            background: linear-gradient(180deg, rgba(15, 20, 25, 0.6) 0%, rgba(26, 31, 37, 0.4) 100%);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            position: relative;
        }
        
        .welcome-message {
            text-align: center;
            padding: var(--spacing-3xl) var(--spacing-2xl);
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--border-radius-lg);
            border: 1px dashed var(--dark-border);
            animation: fadeInUp 0.6s ease;
            margin: auto;
            max-width: 600px;
            backdrop-filter: blur(5px);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .welcome-icon {
            margin-bottom: var(--spacing-lg);
            animation: logoFloat 3s ease-in-out infinite;
        }
        
        .welcome-message h3 {
            color: var(--dark-text);
            margin-bottom: var(--spacing-md);
        }
        
        .welcome-message p {
            color: var(--dark-text-secondary);
            max-width: 500px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* ===== MESSAGES ===== */
        .message {
            max-width: 65%;
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            position: relative;
            animation: messageAppear 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            word-wrap: break-word;
            overflow-wrap: break-word;
            backdrop-filter: blur(5px);
        }
        
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .message-outgoing {
            background: linear-gradient(135deg, rgba(66, 133, 244, 0.15) 0%, rgba(66, 133, 244, 0.08) 100%);
            border: 1px solid rgba(66, 133, 244, 0.2);
            color: var(--dark-text);
            align-self: flex-end;
            border-bottom-right-radius: var(--border-radius-sm);
            margin-left: auto;
        }
        
        .message-outgoing::after {
            content: '';
            position: absolute;
            right: -6px;
            bottom: 0;
            width: 0;
            height: 0;
            border: 6px solid transparent;
            border-left-color: rgba(66, 133, 244, 0.2);
            border-right: 0;
            border-bottom: 0;
        }
        
        .message-incoming {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid var(--dark-border);
            align-self: flex-start;
            border-bottom-left-radius: var(--border-radius-sm);
        }
        
        .message-incoming::after {
            content: '';
            position: absolute;
            left: -6px;
            bottom: 0;
            width: 0;
            height: 0;
            border: 6px solid transparent;
            border-right-color: var(--dark-border);
            border-left: 0;
            border-bottom: 0;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xs);
            font-size: 0.875rem;
        }
        
        .message-user {
            font-weight: 500;
            color: var(--primary-light);
        }
        
        .message-time {
            opacity: 0.7;
            font-size: 0.75rem;
            color: var(--dark-text-secondary);
        }
        
        .message-text {
            line-height: 1.5;
            margin-bottom: var(--spacing-xs);
            color: var(--dark-text);
        }
        
        .message-status {
            text-align: right;
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: var(--spacing-xs);
            color: var(--dark-text-secondary);
        }
        
        .system-message {
            align-self: center;
            background: rgba(52, 168, 83, 0.1);
            color: var(--secondary-light);
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--border-radius-full);
            font-size: 0.875rem;
            max-width: 80%;
            text-align: center;
            animation: fadeIn var(--transition-normal);
            border: 1px solid rgba(52, 168, 83, 0.2);
        }
        
        .system-message.error {
            background: rgba(234, 67, 53, 0.1);
            color: var(--error-light);
            border-color: rgba(234, 67, 53, 0.2);
        }
        
        .system-message.warning {
            background: rgba(251, 188, 5, 0.1);
            color: var(--warning-light);
            border-color: rgba(251, 188, 5, 0.2);
        }
        
        /* ===== INPUT AREA ===== */
        .input-area {
            padding: var(--spacing-lg) var(--spacing-2xl);
            border-top: 1px solid var(--dark-border);
            background: rgba(26, 31, 37, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            gap: var(--spacing-lg);
            align-items: flex-end;
            position: sticky;
            bottom: 0;
        }
        
        .message-input {
            flex: 1;
            padding: var(--spacing-lg);
            border: 2px solid var(--dark-border);
            border-radius: var(--border-radius-full);
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            min-height: 52px;
            max-height: 150px;
            outline: none;
            transition: all var(--transition-fast);
            background: rgba(255, 255, 255, 0.05);
            color: var(--dark-text);
        }
        
        .message-input:focus {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }
        
        .message-input:disabled {
            background: rgba(255, 255, 255, 0.03);
            cursor: not-allowed;
        }
        
        .message-input::placeholder {
            color: var(--dark-text-secondary);
        }
        
        .send-button {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all var(--transition-fast);
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }
        
        .send-button:hover:not(:disabled) {
            transform: scale(1.05) rotate(5deg);
            box-shadow: 0 6px 16px rgba(66, 133, 244, 0.4);
        }
        
        .send-button:active:not(:disabled) {
            transform: scale(0.95);
        }
        
        .send-button:disabled {
            background: var(--gray-600);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .send-icon {
            width: 24px;
            height: 24px;
            fill: white;
            transition: transform var(--transition-fast);
        }
        
        .send-button:hover:not(:disabled) .send-icon {
            transform: translateX(2px);
        }
        
        /* ===== SCROLLBAR STYLING ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--gray-600);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }
        
        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1200px) {
            .chat-app {
                height: 94vh;
            }
            
            .sidebar {
                width: 280px;
            }
        }
        
        @media (max-width: 992px) {
            .chat-app {
                flex-direction: column;
                height: 96vh;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 50vh;
                overflow-y: auto;
                border-right: none;
                border-bottom: 1px solid var(--dark-border);
            }
            
            .sidebar-footer {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .btn {
                min-height: 70px;
            }
            
            .message {
                max-width: 75%;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-md);
            }
            
            .chat-app {
                height: 100vh;
                border-radius: var(--border-radius-md);
            }
            
            .chat-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-md);
                padding: var(--spacing-md);
            }
            
            .chat-title {
                gap: var(--spacing-md);
            }
            
            .chat-icon {
                width: 24px;
                height: 24px;
            }
            
            .messages-container {
                padding: var(--spacing-lg);
            }
            
            .input-area {
                padding: var(--spacing-md);
            }
            
            .sidebar-footer {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn-logout {
                grid-column: span 2;
            }
            
            .message {
                max-width: 85%;
                padding: var(--spacing-md);
            }
        }
        
        @media (max-width: 576px) {
            .login-card {
                padding: var(--spacing-2xl);
            }
            
            .sidebar-footer {
                grid-template-columns: 1fr;
            }
            
            .btn-logout {
                grid-column: span 1;
            }
            
            .btn {
                aspect-ratio: auto;
                min-height: 60px;
                flex-direction: row;
                justify-content: flex-start;
                padding: var(--spacing-md) var(--spacing-lg);
            }
            
            .btn-icon {
                width: 20px;
                height: 20px;
            }
            
            .btn-text {
                font-size: 12px;
            }
            
            .message {
                max-width: 90%;
                padding: var(--spacing-sm) var(--spacing-md);
            }
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
        
        .visible {
            display: flex !important;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .error-text {
            color: var(--error-light);
        }
        
        .success-text {
            color: var(--secondary-light);
        }
        
        .warning-text {
            color: var(--warning-light);
        }
        
        /* ===== ANIMATIONS ===== */
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.5s ease;
        }
        
        /* ===== PRINT STYLES ===== */
        @media print {
            .login-modal,
            .sidebar-footer,
            .input-area,
            .typing-indicator {
                display: none !important;
            }
            
            .chat-app {
                box-shadow: none;
                border: 1px solid #ccc;
                height: auto;
            }
            
            .messages-container {
                overflow: visible;
                max-height: none;
            }
        }
        
        /* ===== MOUSE TRACKING FOR BUTTONS ===== */
        .btn {
            --mouse-x: 50%;
            --mouse-y: 50%;
        }
        
        .btn:hover {
            background: radial-gradient(
                circle at var(--mouse-x) var(--mouse-y), 
                rgba(255, 255, 255, 0.1), 
                transparent 80px
            ), var(--btn-hover-bg, rgba(255, 255, 255, 0.08));
        }
                
    </style>
</head>
<body>
    <script>
                // ============================================================================
        // OMI Chat v0.2 - Основной файл JavaScript
        // ============================================================================
        
        // ===== КОНФИГУРАЦИЯ =====
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbz2LBCDbWMLROdFuyKTa4SWipi2DgqJIGrwHvn2zXOnXt8HXQw0XBYOcghK_4Je6aRWnQ/exec',
            POLL_INTERVAL: 2000, // 2 секунды
            MAX_MESSAGES: 500,
            MAX_USERNAME_LENGTH: 20,
            SESSION_ID: 'omichat_v0.3',
            VERSION: '0.3'
        };
        
        // ===== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ =====
        let state = {
            currentUser: '',
            messages: [],
            onlineUsers: new Set(),
            lastMessageId: 0,
            isTyping: false,
            isConnected: false,
            pollInterval: null,
            typingTimeout: null,
            connectionRetries: 0,
            maxRetries: 5,
            newMessagesCount: 0,
            unreadCount: 0
        };
        
        // ===== УТИЛИТЫ =====
        const Utils = {
            // Форматирование времени
            formatTime: (timeString) => {
                if (!timeString) return '';
                
                try {
                    const date = new Date(timeString);
                    if (isNaN(date.getTime())) {
                        return timeString;
                    }
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    return timeString;
                }
            },
        
            // Экранирование HTML
            escapeHtml: (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
        
            // Генерация случайного цвета для аватара
            generateAvatarColor: (username) => {
                const colors = [
                    '#4285F4', '#34A853', '#FBBC05', '#EA4335',
                    '#8AB4F8', '#81C995', '#FDE293', '#F28B82',
                    '#5C6BC0', '#26A69A', '#FFA726', '#AB47BC'
                ];
                const hash = Array.from(username).reduce((acc, char) => 
                    acc + char.charCodeAt(0), 0);
                return colors[hash % colors.length];
            },
        
            // Анимация элемента
            animateElement: (element, animation) => {
                element.classList.add(animation);
                element.addEventListener('animationend', () => {
                    element.classList.remove(animation);
                }, { once: true });
            },
        
            // Сохранение в LocalStorage
            saveToStorage: (key, value) => {
                try {
                    localStorage.setItem(`omichat_${key}`, JSON.stringify(value));
                } catch (e) {
                    console.error('Ошибка сохранения:', e);
                }
            },
        
            // Загрузка из LocalStorage
            loadFromStorage: (key) => {
                try {
                    const item = localStorage.getItem(`omichat_${key}`);
                    return item ? JSON.parse(item) : null;
                } catch (e) {
                    console.error('Ошибка загрузки:', e);
                    return null;
                }
            },
        
            // Отслеживание позиции мыши для кнопок
            setupMouseTracking: () => {
                const buttons = document.querySelectorAll('.btn');
                buttons.forEach(btn => {
                    btn.addEventListener('mousemove', (e) => {
                        const rect = btn.getBoundingClientRect();
                        const x = ((e.clientX - rect.left) / rect.width) * 100;
                        const y = ((e.clientY - rect.top) / rect.height) * 100;
                        
                        btn.style.setProperty('--mouse-x', `${x}%`);
                        btn.style.setProperty('--mouse-y', `${y}%`);
                    });
                });
            }
        };
        
        // ===== УПРАВЛЕНИЕ СОСТОЯНИЕМ =====
        const StateManager = {
            // Сохранение состояния
            saveState: () => {
                Utils.saveToStorage('state', {
                    currentUser: state.currentUser,
                    messages: state.messages.slice(-100), // Сохраняем только последние 100
                    lastMessageId: state.lastMessageId,
                    onlineUsers: Array.from(state.onlineUsers)
                });
            },
        
            // Восстановление состояния
            restoreState: () => {
                const savedState = Utils.loadFromStorage('state');
                if (savedState) {
                    state.currentUser = savedState.currentUser || '';
                    state.messages = savedState.messages || [];
                    state.lastMessageId = savedState.lastMessageId || 0;
                    state.onlineUsers = new Set(savedState.onlineUsers || []);
                    return true;
                }
                return false;
            },
        
            // Сброс состояния
            resetState: () => {
                state = {
                    currentUser: '',
                    messages: [],
                    onlineUsers: new Set(),
                    lastMessageId: 0,
                    isTyping: false,
                    isConnected: false,
                    pollInterval: null,
                    typingTimeout: null,
                    connectionRetries: 0,
                    maxRetries: 5,
                    newMessagesCount: 0,
                    unreadCount: 0
                };
                localStorage.removeItem('omichat_state');
            }
        };
        
        // ===== API КЛИЕНТ =====
        const ApiClient = {
            // Проверка подключения
            checkConnection: async () => {
                try {
                    const response = await fetch(CONFIG.API_URL + '?ping=' + Date.now());
                    return response.ok;
                } catch (error) {
                    console.error('Ошибка подключения:', error);
                    return false;
                }
            },
        
            // Получение сообщений
            fetchMessages: async () => {
                try {
                    const response = await fetch(CONFIG.API_URL + '?t=' + Date.now());
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    return Array.isArray(data) ? data : [];
                } catch (error) {
                    console.error('Ошибка получения сообщений:', error);
                    throw error;
                }
            },
        
            // Отправка сообщения
            sendMessage: async (user, message) => {
                try {
                    const response = await fetch(CONFIG.API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            user: user,
                            message: message,
                            session: CONFIG.SESSION_ID,
                            version: CONFIG.VERSION
                        })
                    });
                    
                    const result = await response.json();
                    return {
                        success: result.success === true,
                        id: result.id || Date.now(),
                        timestamp: result.timestamp || new Date().toISOString()
                    };
                } catch (error) {
                    console.error('Ошибка отправки сообщения:', error);
                    throw error;
                }
            }
        };
        
        // ===== УПРАВЛЕНИЕ ДОМ =====
        const DomManager = {
            // Элементы
            elements: {},
        
            // Инициализация элементов
            initElements: () => {
                DomManager.elements = {
                    // Модальное окно
                    loginModal: document.getElementById('loginModal'),
                    usernameInput: document.getElementById('usernameInput'),
                    
                    // Основной интерфейс
                    chatInterface: document.getElementById('chatInterface'),
                    currentUsername: document.getElementById('currentUsername'),
                    userAvatar: document.getElementById('userAvatar'),
                    
                    // Статус
                    connectionStatus: document.getElementById('connectionStatus'),
                    statusText: document.getElementById('statusText'),
                    
                    // Список пользователей
                    usersList: document.getElementById('usersList'),
                    onlineCount: document.getElementById('onlineCount'),
                    onlineCountBadge: document.getElementById('onlineCountBadge'),
                    
                    // Сообщения
                    messagesContainer: document.getElementById('messagesContainer'),
                    messageCount: document.getElementById('messageCount'),
                    welcomeMessage: document.getElementById('welcomeMessage'),
                    
                    // Ввод
                    messageInput: document.getElementById('messageInput'),
                    sendButton: document.getElementById('sendButton'),
                    
                    // Прочее
                    lastUpdate: document.getElementById('lastUpdate'),
                    typingIndicator: document.getElementById('typingIndicator'),
                    connectionInfo: document.getElementById('connectionInfo'),
                    
                    // Кнопки
                    refreshBtn: document.getElementById('refreshBtn'),
                    exportBtn: document.getElementById('exportBtn'),
                    settingsBtn: document.getElementById('settingsBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    usersBtn: document.getElementById('usersBtn'),
                    helpBtn: document.getElementById('helpBtn'),
                    logoutBtn: document.getElementById('logoutBtn'),
                    refreshBadge: document.getElementById('refreshBadge')
                };
            },
        
            // Обновление статуса
            updateStatus: (text, isError = false) => {
                const { statusText, connectionStatus, connectionInfo } = DomManager.elements;
                
                statusText.textContent = text;
                connectionInfo.textContent = text;
                
                if (isError) {
                    connectionStatus.classList.add('status-disconnected');
                    connectionStatus.classList.remove('status-connected');
                    Utils.animateElement(connectionStatus, 'shake');
                } else {
                    connectionStatus.classList.add('status-connected');
                    connectionStatus.classList.remove('status-disconnected');
                }
            },
        
            // Обновление списка онлайн пользователей
            updateOnlineUsers: () => {
                const { usersList, onlineCount, onlineCountBadge } = DomManager.elements;
                
                usersList.innerHTML = '';
                state.onlineUsers.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = `user-item ${user === state.currentUser ? 'self' : ''}`;
                    userDiv.innerHTML = `
                        <span style="color: ${Utils.generateAvatarColor(user)}; margin-right: 8px;">●</span>
                        <span style="flex: 1;">${Utils.escapeHtml(user)}</span>
                        ${user === state.currentUser ? 
                            '<small style="color: #666; font-size: 0.75rem;">(Вы)</small>' : ''}
                    `;
                    usersList.appendChild(userDiv);
                });
                
                const count = state.onlineUsers.size;
                onlineCount.textContent = count;
                onlineCountBadge.textContent = count;
            },
        
            // Добавление сообщения в интерфейс
            addMessage: (user, text, timestamp, id, isOwn = false) => {
                const { messagesContainer } = DomManager.elements;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOwn ? 'message-outgoing' : 'message-incoming'}`;
                messageDiv.dataset.id = id;
                
                const time = Utils.formatTime(timestamp);
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-user">${isOwn ? 'Вы' : Utils.escapeHtml(user)}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${Utils.escapeHtml(text)}</div>
                    <div class="message-status">${isOwn ? '✓' : ''}</div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                
                // Прокрутка к последнему сообщению
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Добавляем в состояние
                state.messages.push({
                    id: id,
                    user: user,
                    text: text,
                    time: timestamp,
                    isOwn: isOwn
                });
                
                // Обновляем счетчик
                DomManager.updateMessageCount();
                
                // Анимация
                Utils.animateElement(messageDiv, 'messageAppear');
            },
        
            // Обновление счетчика сообщений
            updateMessageCount: () => {
                const { messageCount } = DomManager.elements;
                messageCount.textContent = state.messages.length;
            },
        
            // Обновление времени последнего обновления
            updateLastUpdate: () => {
                const { lastUpdate } = DomManager.elements;
                const now = new Date();
                const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                lastUpdate.textContent = timeStr;
            },
        
            // Показ индикатора набора текста
            showTypingIndicator: () => {
                const { typingIndicator } = DomManager.elements;
                typingIndicator.style.display = 'flex';
            },
        
            // Скрытие индикатора набора текста
            hideTypingIndicator: () => {
                const { typingIndicator } = DomManager.elements;
                typingIndicator.style.display = 'none';
            },
        
            // Авто-ресайз поля ввода
            autoResizeTextarea: (textarea) => {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
            },
        
            // Показ приветственного сообщения
            showWelcomeMessage: () => {
                const { welcomeMessage } = DomManager.elements;
                welcomeMessage.style.display = 'block';
            },
        
            // Скрытие приветственного сообщения
            hideWelcomeMessage: () => {
                const { welcomeMessage } = DomManager.elements;
                welcomeMessage.style.display = 'none';
            },
        
            // Обновление бейджа новых сообщений
            updateNewMessagesBadge: (count) => {
                const { refreshBadge } = DomManager.elements;
                if (count > 0) {
                    refreshBadge.textContent = count;
                    refreshBadge.style.display = 'inline-block';
                    Utils.animateElement(refreshBadge, 'badgePulse');
                } else {
                    refreshBadge.style.display = 'none';
                }
            },
        
            // Анимация кнопки
            animateButton: (buttonId, animationClass) => {
                const button = document.getElementById(buttonId);
                if (button) {
                    Utils.animateElement(button, animationClass);
                }
            }
        };
        
        // ===== ОБРАБОТЧИКИ СОБЫТИЙ =====
        const EventHandlers = {
            // Обработчик входа
            handleLogin: () => {
                const { usernameInput } = DomManager.elements;
                const username = usernameInput.value.trim();
                
                if (!username) {
                    alert('Пожалуйста, введите ваше имя');
                    Utils.animateElement(usernameInput, 'shake');
                    return;
                }
                
                if (username.length > CONFIG.MAX_USERNAME_LENGTH) {
                    alert(`Имя должно быть не длиннее ${CONFIG.MAX_USERNAME_LENGTH} символов`);
                    return;
                }
                
                state.currentUser = username;
                Utils.saveToStorage('username', username);
                
                // Скрываем модальное окно
                DomManager.elements.loginModal.style.display = 'none';
                
                // Инициализируем чат
                ChatManager.initChat();
            },
        
            // Обработчик отправки сообщения
            handleSendMessage: async () => {
                const { messageInput } = DomManager.elements;
                const text = messageInput.value.trim();
                
                if (!text || !state.currentUser) return;
                
                // Очищаем поле ввода
                messageInput.value = '';
                DomManager.autoResizeTextarea(messageInput);
                
                // Показываем сообщение локально
                const tempId = Date.now();
                DomManager.addMessage(
                    state.currentUser,
                    text,
                    new Date().toISOString(),
                    tempId,
                    true
                );
                
                // Анимация кнопки отправки
                DomManager.animateButton('sendButton', 'scaleIn');
                
                // Отправляем на сервер
                try {
                    const result = await ApiClient.sendMessage(state.currentUser, text);
                    
                    if (result.success) {
                        DomManager.updateStatus('Сообщение отправлено');
                        state.lastMessageId = Math.max(state.lastMessageId, result.id);
                        
                        // Анимация кнопки обновления
                        DomManager.animateButton('refreshBtn', 'pulse');
                    } else {
                        DomManager.updateStatus('Ошибка отправки', true);
                    }
                } catch (error) {
                    DomManager.updateStatus('Ошибка сети', true);
                }
                
                // Сбрасываем статус набора
                TypingManager.stopTyping();
            },
        
            // Обработчик клавиш
            handleKeyDown: (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    EventHandlers.handleSendMessage();
                } else if (event.key === 'Escape') {
                    DomManager.elements.messageInput.value = '';
                    DomManager.autoResizeTextarea(DomManager.elements.messageInput);
                }
            },
        
            // Обработчик выхода
            handleLogout: () => {
                if (confirm('Выйти из чата?')) {
                    ChatManager.stopPolling();
                    StateManager.resetState();
                    
                    // Показываем модальное окно входа
                    DomManager.elements.loginModal.style.display = 'flex';
                    DomManager.elements.chatInterface.style.display = 'none';
                    DomManager.elements.usernameInput.value = '';
                    DomManager.elements.usernameInput.focus();
                    
                    // Очищаем сообщения
                    DomManager.elements.messagesContainer.innerHTML = '';
                    DomManager.showWelcomeMessage();
                    
                    // Сбрасываем бейджи
                    DomManager.updateNewMessagesBadge(0);
                }
            },
        
            // Обработчик обновления чата
            handleRefreshChat: () => {
                ChatManager.loadMessages();
                DomManager.updateStatus('Обновление...');
                DomManager.updateNewMessagesBadge(0);
                state.newMessagesCount = 0;
                
                // Анимация кнопки
                DomManager.animateButton('refreshBtn', 'spin');
            },
        
            // Очистка локального чата
            handleClearLocalChat: () => {
                if (confirm('Очистить локальную историю сообщений?\nЭто не удалит сообщения из Google Sheets.')) {
                    state.messages = [];
                    DomManager.elements.messagesContainer.innerHTML = '';
                    DomManager.updateMessageCount();
                    DomManager.showWelcomeMessage();
                    
                    // Показываем уведомление
                    const notification = document.createElement('div');
                    notification.className = 'system-message success';
                    notification.textContent = 'Локальная история очищена';
                    DomManager.elements.messagesContainer.appendChild(notification);
                    
                    setTimeout(() => notification.remove(), 3000);
                    
                    // Анимация кнопки
                    DomManager.animateButton('clearBtn', 'shake');
                }
            },
        
            // Показать список пользователей
            handleShowUsers: () => {
                const usersList = Array.from(state.onlineUsers).join('\n• ');
                alert(`👥 Пользователи онлайн (${state.onlineUsers.size}):\n\n• ${usersList || 'Нет активных пользователей'}`);
            },
        
            // Показать справку
            handleShowHelp: () => {
                alert(`📚 OMI Chat v${CONFIG.VERSION} - Справка
        
        Основные функции:
        • 💬 Напишите сообщение и нажмите Enter
        • 🔄 Обновить - загрузить новые сообщения
        • 📥 Экспорт - сохранить историю в файл
        • ⚙️ Настройки - информация о системе
        • 🗑️ Очистить - удалить локальную историю
        • 👥 Участники - список онлайн пользователей
        • 🚪 Выйти - выход из аккаунта
        
        Горячие клавиши:
        • Enter - отправить сообщение
        • Shift+Enter - новая строка
        • Esc - очистить поле ввода
        
        Сообщения сохраняются в Google Sheets:
        https://docs.google.com/spreadsheets/d/1llN40GyGlHZGd_6vBNl8dh5RujaA6A68Tl77XbDG1pk/edit
        
        Версия: ${CONFIG.VERSION}`);
            }
        };
        
        // ===== УПРАВЛЕНИЕ НАБОРОМ ТЕКСТА =====
        const TypingManager = {
            // Начало набора
            startTyping: () => {
                if (!state.isTyping) {
                    state.isTyping = true;
                    DomManager.showTypingIndicator();
                }
                
                clearTimeout(state.typingTimeout);
                state.typingTimeout = setTimeout(TypingManager.stopTyping, 3000);
            },
        
            // Остановка набора
            stopTyping: () => {
                state.isTyping = false;
                DomManager.hideTypingIndicator();
                clearTimeout(state.typingTimeout);
            }
        };
        
        // ===== УПРАВЛЕНИЕ ЧАТОМ =====
        const ChatManager = {
            // Инициализация чата
            initChat: async () => {
                // Показываем интерфейс
                DomManager.elements.chatInterface.style.display = 'flex';
                DomManager.elements.currentUsername.textContent = state.currentUser;
                
                // Настраиваем аватар
                const avatarColor = Utils.generateAvatarColor(state.currentUser);
                const avatar = DomManager.elements.userAvatar;
                avatar.style.background = `linear-gradient(135deg, ${avatarColor} 0%, ${this.adjustColor(avatarColor, -20)} 100%)`;
                avatar.querySelector('span').textContent = state.currentUser.charAt(0).toUpperCase();
                
                // Добавляем пользователя в онлайн
                state.onlineUsers.add(state.currentUser);
                DomManager.updateOnlineUsers();
                
                // Активируем поле ввода
                DomManager.elements.messageInput.disabled = false;
                DomManager.elements.sendButton.disabled = false;
                DomManager.elements.messageInput.focus();
                
                // Настраиваем обработчики
                DomManager.elements.messageInput.addEventListener('input', (e) => {
                    DomManager.autoResizeTextarea(e.target);
                    TypingManager.startTyping();
                });
                
                DomManager.elements.messageInput.addEventListener('keydown', EventHandlers.handleKeyDown);
                
                // Настраиваем обработчики кнопок
                DomManager.elements.refreshBtn.addEventListener('click', EventHandlers.handleRefreshChat);
                DomManager.elements.exportBtn.addEventListener('click', ChatManager.exportChat);
                DomManager.elements.settingsBtn.addEventListener('click', ChatManager.showSettings);
                DomManager.elements.clearBtn.addEventListener('click', EventHandlers.handleClearLocalChat);
                DomManager.elements.usersBtn.addEventListener('click', EventHandlers.handleShowUsers);
                DomManager.elements.helpBtn.addEventListener('click', EventHandlers.handleShowHelp);
                DomManager.elements.logoutBtn.addEventListener('click', EventHandlers.handleLogout);
                
                // Настраиваем отслеживание мыши для кнопок
                Utils.setupMouseTracking();
                
                // Загружаем сообщения и начинаем опрос
                await ChatManager.loadMessages();
                ChatManager.startPolling();
                
                // Обновляем статус
                DomManager.updateStatus('Подключено');
                DomManager.updateLastUpdate();
                DomManager.hideWelcomeMessage();
            },
        
            // Загрузка сообщений
            loadMessages: async () => {
                try {
                    const newMessages = await ApiClient.fetchMessages();
                    
                    if (newMessages.length > 0) {
                        // Фильтруем новые сообщения
                        const latestMessages = newMessages.filter(msg => {
                            const msgId = parseInt(msg.id) || 0;
                            return msgId > state.lastMessageId;
                        });
                        
                        if (latestMessages.length > 0) {
                            latestMessages.forEach(msg => {
                                const isOwn = msg.user === state.currentUser;
                                DomManager.addMessage(
                                    msg.user,
                                    msg.message,
                                    msg.timestamp,
                                    msg.id,
                                    isOwn
                                );
                                
                                state.lastMessageId = Math.max(state.lastMessageId, parseInt(msg.id) || 0);
                                
                                // Добавляем пользователя в онлайн
                                if (msg.user && msg.user !== state.currentUser) {
                                    state.onlineUsers.add(msg.user);
                                }
                            });
                            
                            // Обновляем счетчик новых сообщений
                            if (!document.hasFocus()) {
                                state.newMessagesCount += latestMessages.length;
                                DomManager.updateNewMessagesBadge(state.newMessagesCount);
                            }
                            
                            DomManager.updateOnlineUsers();
                            DomManager.updateLastUpdate();
                            StateManager.saveState();
                        }
                    }
                    
                    state.isConnected = true;
                    state.connectionRetries = 0;
                    DomManager.updateStatus('Подключено');
                    
                } catch (error) {
                    state.connectionRetries++;
                    
                    if (state.connectionRetries >= state.maxRetries) {
                        DomManager.updateStatus('Ошибка соединения', true);
                        ChatManager.stopPolling();
                    } else {
                        DomManager.updateStatus(`Переподключение (${state.connectionRetries}/${state.maxRetries})...`);
                    }
                }
            },
        
            // Начало опроса сообщений
            startPolling: () => {
                if (state.pollInterval) {
                    clearInterval(state.pollInterval);
                }
                
                state.pollInterval = setInterval(() => {
                    if (document.visibilityState === 'visible') {
                        ChatManager.loadMessages();
                    }
                }, CONFIG.POLL_INTERVAL);
            },
        
            // Остановка опроса
            stopPolling: () => {
                if (state.pollInterval) {
                    clearInterval(state.pollInterval);
                    state.pollInterval = null;
                }
            },
        
            // Экспорт чата
            exportChat: () => {
                if (state.messages.length === 0) {
                    alert('Нет сообщений для экспорта');
                    return;
                }
                
                const chatText = state.messages.map(msg => 
                    `[${Utils.formatTime(msg.time)}] ${msg.user}: ${msg.text}`
                ).join('\n');
                
                const header = `OMI Chat v${CONFIG.VERSION} - Экспорт истории\n` +
                              `Дата: ${new Date().toLocaleString()}\n` +
                              `Пользователь: ${state.currentUser}\n` +
                              `Сообщений: ${state.messages.length}\n` +
                              '='.repeat(50) + '\n\n';
                
                const blob = new Blob([header + chatText], { 
                    type: 'text/plain;charset=utf-8' 
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `omichat_export_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Анимация кнопки
                DomManager.animateButton('exportBtn', 'scaleIn');
            },
        
            // Показ настроек
            showSettings: () => {
                const settings = `
                    OMI Chat v${CONFIG.VERSION}
                    
                    Пользователь: ${state.currentUser}
                    Сообщений: ${state.messages.length}
                    Онлайн: ${state.onlineUsers.size}
                    
                    API URL: ${CONFIG.API_URL}
                    Таблица: https://docs.google.com/spreadsheets/d/1llN40GyGlHZGd_6vBNl8dh5RujaA6A68Tl77XbDG1pk/edit
                    
                    Интервал опроса: ${CONFIG.POLL_INTERVAL / 1000} сек
                    Макс. сообщений: ${CONFIG.MAX_MESSAGES}
                    
                    Статус: ${state.isConnected ? 'Подключено ✓' : 'Отключено ✗'}
                    Попыток переподключения: ${state.connectionRetries}
                `;
                
                alert(settings);
                
                // Анимация кнопки
                DomManager.animateButton('settingsBtn', 'pulse');
            },
        
            // Вспомогательная функция для настройки цвета
            adjustColor: (color, amount) => {
                let usePound = false;
                
                if (color[0] === "#") {
                    color = color.slice(1);
                    usePound = true;
                }
                
                const num = parseInt(color, 16);
                let r = (num >> 16) + amount;
                let g = ((num >> 8) & 0x00FF) + amount;
                let b = (num & 0x0000FF) + amount;
                
                r = Math.min(Math.max(0, r), 255);
                g = Math.min(Math.max(0, g), 255);
                b = Math.min(Math.max(0, b), 255);
                
                return (usePound ? "#" : "") + (b | (g << 8) | (r << 16)).toString(16).padStart(6, '0');
            }
        };
        
        // ===== ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ =====
        const App = {
            // Инициализация
            init: () => {
                // Инициализация DOM элементов
                DomManager.initElements();
                
                // Восстановление состояния
                const hasState = StateManager.restoreState();
                
                if (hasState && state.currentUser) {
                    // Пользователь уже авторизован
                    DomManager.elements.loginModal.style.display = 'none';
                    ChatManager.initChat();
                } else {
                    // Проверяем сохраненное имя пользователя
                    const savedUsername = Utils.loadFromStorage('username');
                    if (savedUsername) {
                        state.currentUser = savedUsername;
                        DomManager.elements.loginModal.style.display = 'none';
                        ChatManager.initChat();
                    } else {
                        // Показываем окно входа
                        DomManager.elements.loginModal.style.display = 'flex';
                        DomManager.elements.usernameInput.focus();
                    }
                }
                
                // Настройка глобальных обработчиков
                App.setupGlobalHandlers();
                
                // Проверка соединения
                App.checkInitialConnection();
            },
        
            // Настройка глобальных обработчиков
            setupGlobalHandlers: () => {
                // Обработчик видимости вкладки
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible' && state.currentUser) {
                        ChatManager.loadMessages();
                        // Сбрасываем счетчик новых сообщений при фокусе
                        if (state.newMessagesCount > 0) {
                            state.newMessagesCount = 0;
                            DomManager.updateNewMessagesBadge(0);
                        }
                    }
                });
                
                // Автоочистка неактивных пользователей
                setInterval(() => {
                    if (state.onlineUsers.size > 1) {
                        // Оставляем текущего пользователя и 4 последних активных
                        const activeUsers = new Set([state.currentUser]);
                        const otherUsers = Array.from(state.onlineUsers)
                            .filter(user => user !== state.currentUser)
                            .slice(-4);
                        
                        otherUsers.forEach(user => activeUsers.add(user));
                        state.onlineUsers = activeUsers;
                        DomManager.updateOnlineUsers();
                    }
                }, 60000); // Каждую минуту
                
                // Уведомление о новом сообщении
                document.addEventListener('DOMContentLoaded', () => {
                    if ('Notification' in window && Notification.permission === 'default') {
                        Notification.requestPermission();
                    }
                });
            },
        
            // Первоначальная проверка соединения
            checkInitialConnection: async () => {
                const isConnected = await ApiClient.checkConnection();
                
                if (!isConnected) {
                    DomManager.updateStatus('Не удалось подключиться к серверу', true);
                }
            }
        };
        
        // ===== ГЛОБАЛЬНЫЕ ФУНКЦИИ ДЛЯ HTML =====
        // Эти функции вызываются из onclick атрибутов
        
        function login() {
            EventHandlers.handleLogin();
        }
        
        function sendMessage() {
            EventHandlers.handleSendMessage();
        }
        
        function logout() {
            EventHandlers.handleLogout();
        }
        
        function refreshChat() {
            EventHandlers.handleRefreshChat();
        }
        
        function exportChat() {
            ChatManager.exportChat();
        }
        
        function showSettings() {
            ChatManager.showSettings();
        }
        
        function clearLocalChat() {
            EventHandlers.handleClearLocalChat();
        }
        
        function showUsers() {
            EventHandlers.handleShowUsers();
        }
        
        function showHelp() {
            EventHandlers.handleShowHelp();
        }
        
        function autoResize(textarea) {
            DomManager.autoResizeTextarea(textarea);
        }
        
        function handleKeyDown(event) {
            EventHandlers.handleKeyDown(event);
        }
        
        function initApp() {
            App.init();
        }
        
        // Экспорт для тестирования
        if (typeof module !== 'undefined' && module.exports) {
            module.exports = {
                App,
                ChatManager,
                StateManager,
                Utils,
                EventHandlers
            };
        }
    </script>
    
    <!-- Модальное окно входа -->
    <div id="loginModal" class="login-modal">
        <div class="login-card">
            <div class="login-logo">
                <svg width="80" height="80" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-3 12H7c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1s-.45 1-1 1zm0-4H7c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1s-.45 1-1 1z"/>
                </svg>
            </div>
            <h2>Добро пожаловать в OMI Chat!</h2>
            <p>Введите ваше имя для начала общения</p>
            <input type="text" id="usernameInput" class="login-input" 
                   placeholder="Как вас зовут?" maxlength="20" autofocus>
            <button onclick="login()" class="login-button">Войти в чат</button>
            <div class="login-footer">
                <small>Версия 0.2 • Использует Google Sheets API</small>
            </div>
        </div>
    </div>
    
    <!-- Основной интерфейс чата -->
    <div id="chatInterface" class="chat-app">
        <!-- Боковая панель -->
        <div class="sidebar">
            <div class="user-card">
                <div class="avatar" id="userAvatar">
                    <span>U</span>
                </div>
                <h3 id="currentUsername">Гость</h3>
                <div class="connection-status" id="connectionStatus">
                    <span class="status-indicator"></span>
                    <span id="statusText">Отключено</span>
                </div>
                <div class="user-stats">
                    <div class="stat-item">
                        <span class="stat-icon">💬</span>
                        <span id="messageCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">👥</span>
                        <span id="onlineCount">0</span>
                    </div>
                </div>
            </div>
            
            <div class="online-users">
                <h4>
                    <span class="icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="#34A853">
                            <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                        </svg>
                    </span>
                    <span>Онлайн</span>
                    <span id="onlineCountBadge" class="badge">0</span>
                </h4>
                <div id="usersList">
                    <!-- Список пользователей будет здесь -->
                </div>
            </div>
            
            <!-- Квадратные кнопки в сетке 3x2 -->
            <div class="sidebar-footer">
                <!-- Первый ряд -->
                <button onclick="refreshChat()" class="btn btn-primary" title="Обновить сообщения" id="refreshBtn">
                    <div class="btn-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                    </div>
                    <span class="btn-text">Обновить</span>
                    <span id="refreshBadge" class="btn-badge">0</span>
                </button>
                
                <button onclick="exportChat()" class="btn btn-success" title="Экспортировать историю" id="exportBtn">
                    <div class="btn-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                        </svg>
                    </div>
                    <span class="btn-text">Экспорт</span>
                </button>
                
                <button onclick="showSettings()" class="btn btn-secondary" title="Настройки и информация" id="settingsBtn">
                    <div class="btn-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                        </svg>
                    </div>
                    <span class="btn-text">Настройки</span>
                </button>
                
                <!-- Второй ряд -->
                <button onclick="clearLocalChat()" class="btn btn-secondary" title="Очистить локальную историю" id="clearBtn">
                    <div class="btn-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </div>
                    <span class="btn-text">Очистить</span>
                </button>
                
                <button onclick="showUsers()" class="btn btn-secondary" title="Список пользователей" id="usersBtn">
                    <div class="btn-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                        </svg>
                    </div>
                    <span class="btn-text">Участники</span>
                </button>
                
                <button onclick="showHelp()" class="btn btn-secondary" title="Справка и помощь" id="helpBtn">
                    <div class="btn-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/>
                        </svg>
                    </div>
                    <span class="btn-text">Помощь</span>
                </button>
                
                <!-- Кнопка выхода на всю ширину -->
                <button onclick="logout()" class="btn btn-danger btn-logout" title="Выйти из чата" id="logoutBtn">
                    <div class="btn-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                        </svg>
                    </div>
                    <span class="btn-text">Выйти из чата</span>
                </button>
            </div>
        </div>
        
        <!-- Основная область -->
        <div class="chat-main">
            <div class="chat-header">
                <div class="chat-title">
                    <div class="chat-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="#4285F4">
                            <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/>
                        </svg>
                    </div>
                    <div>
                        <h2>Общий чат</h2>
                        <div class="chat-info">
                            <span id="lastUpdate">--:--</span>
                            <span class="divider">•</span>
                            <span id="connectionInfo">Подключение...</span>
                        </div>
                    </div>
                </div>
                <div class="chat-controls">
                    <div id="typingIndicator" class="typing-indicator">
                        <div class="dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span>Кто-то печатает...</span>
                    </div>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- Сообщения будут здесь -->
                <div class="welcome-message" id="welcomeMessage">
                    <div class="welcome-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-3 12H7c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1s-.45 1-1 1zm0-4H7c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1s-.45 1-1 1z"/>
                        </svg>
                    </div>
                    <h3>Добро пожаловать в OMI Chat v0.2!</h3>
                    <p>Это мессенджер на основе Google Sheets. Все сообщения сохраняются в таблице.</p>
                </div>
            </div>
            
            <div class="input-area">
                <textarea 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="Напишите сообщение..." 
                    rows="1"
                    disabled
                ></textarea>
                <button onclick="sendMessage()" class="send-button" id="sendButton" disabled>
                    <svg class="send-icon" width="24" height="24" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script src="Js/app.js"></script>
    <script>
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
    </script>
</body>

</html>




